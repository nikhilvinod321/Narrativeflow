# Editor (TipTap) - Student Deep Dive

This document explains the NarrativeFlow editor in a learning-focused way. You will learn how TipTap works, how the editor is configured, and how content moves from UI to storage.

## 1) Where the Editor Lives

- Core editor: frontend/src/components/editor/StoryEditor.tsx
- Toolbar UI: frontend/src/components/editor/EditorToolbar.tsx
- Page wiring: frontend/src/app/stories/[id]/page.tsx

## 2) TipTap and ProseMirror (Concepts)

TipTap is a React wrapper around ProseMirror. ProseMirror represents documents as a tree of nodes (paragraphs, headings, images) and marks (bold, italic). When you type or click buttons, ProseMirror applies transactions that update this document tree.

In NarrativeFlow:

- The document is stored as HTML.
- TipTap converts between HTML and the ProseMirror document model.

## 3) Extensions Used

Extensions add behaviors and schema entries. NarrativeFlow includes:

- StarterKit: basic paragraph, heading, list, quote, etc.
- Placeholder: text shown when the editor is empty.
- CharacterCount: word and character count.
- Typography: smart quotes and punctuation.
- Highlight: background highlight for text.
- TextStyle + FontFamily: font changes.
- ResizableImage: custom image node with resizing.

## 4) Content Format (Why HTML?)

TipTap outputs HTML. This is practical because:

- It is easy to render in preview mode.
- It can be converted to DOCX/PDF/EPUB.
- It preserves formatting and images.

The downside is that HTML must be cleaned when exporting, which is handled in the export pipeline.

## 5) Toolbar Features

The toolbar triggers TipTap commands. Each command creates a ProseMirror transaction:

- Bold, italic, strike
- Headings (H1, H2, H3)
- Blockquote
- Bullet and ordered lists
- Horizontal rule
- Highlight
- Font family picker
- Undo and redo
- Image insert modal

## 6) Image Insertion

### 6.1 URL Insertion

- User enters a URL.
- Editor inserts an image node with that `src`.

### 6.2 Upload and Gallery

- Uploads go to `/api/images/upload`.
- Backend stores the file in `static/uploads`.
- The editor inserts the returned `file_path`.

Gallery insertion:

- Fetches `/api/images/story/{story_id}`.
- Inserts the selected image's `file_path`.
- Local `/static` paths are normalized into full backend URLs.

## 7) Word Count and Footer

The editor displays word count and character count in a sticky footer. These counts come from TipTap's `CharacterCount` storage.

## 8) Save and Autosave

Save flow:

1. Editor emits HTML on update.
2. Page layer sets a "dirty" flag.
3. Ctrl/Cmd+S triggers `api.updateChapter()`.
4. Server saves HTML to the chapter record.

## 9) Selection Tracking

When text is selected, the editor sends the selection to UI state. That selection is used for:

- Rewrite feature
- Quick summarize action

## 10) Preview Mode

Preview uses the same HTML without editing. This ensures what you see in preview is what exports will use.

## 11) Exercises

1. Add a new TipTap extension and expose it in the toolbar.
2. Insert an image, then export to PDF and verify it appears.
3. Track selection changes and show the selected word count.

## 12) Summary

The editor is a ProseMirror document with extensions that add formatting, images, and UI convenience. Content is stored as HTML, which makes preview and export straightforward but requires careful HTML cleaning later.# Editor (TipTap) - Deep Dive

This document details the NarrativeFlow editor implementation, including TipTap configuration, toolbar actions, image insertion, and save flows.

## 1) Location in Codebase

- Editor component: frontend/src/components/editor/StoryEditor.tsx
- Toolbar component: frontend/src/components/editor/EditorToolbar.tsx
- Editor page wiring: frontend/src/app/stories/[id]/page.tsx

## 2) TipTap Configuration

The editor is created with TipTap's `useEditor` hook and the following extensions:

- StarterKit (base schema and nodes)
- Placeholder (empty state text)
- CharacterCount (word and character count)
- Typography (smart quotes and punctuation)
- Highlight (multicolor highlight)
- TextStyle + FontFamily (font selection)
- ResizableImage (custom image node)

Key editor behaviors:

- `editable` is controlled by `readOnly` prop.
- `onUpdate` emits HTML content and updates word count.
- `onSelectionUpdate` tracks highlighted text for AI actions.

## 3) Content Format

- Content is stored as HTML generated by TipTap.
- This HTML is used for preview, print, and export.

## 4) Toolbar Features

The toolbar supports:

- Text styles: bold, italic, strikethrough
- Headings: H1, H2, H3
- Block quote
- Lists: bullet and ordered
- Horizontal rule
- Highlight
- Font family selection
- Undo/redo
- Image insertion (URL + gallery)

## 5) Image Insertion

Image insertion supports two modes:

1. URL-based insertion
2. Upload to backend gallery

Upload flow:

- Image is uploaded to `/api/images/upload` with form-data.
- Backend stores the file in `static/uploads`.
- The editor inserts the returned `file_path` as an image `src`.

Gallery flow:

- Images are retrieved from `/api/images/story/{story_id}`.
- Selecting a gallery image inserts its `file_path`.
- Local `/static` paths are normalized to full backend URLs.

## 6) Word Count

Word and character counts are computed from TipTap's `CharacterCount` storage and displayed in a sticky footer.

## 7) Save and Autosave

- The page listens for Ctrl/Cmd+S and calls `api.updateChapter()`.
- The editor emits HTML on each update and marks the chapter dirty.
- Manual save and autosave re-use the same update endpoint.

## 8) Selection Tracking

Selected text is stored in the client state and is used for:

- Rewrite action
- Quick actions (summarize)

## 9) Read-Only / Preview Mode

When switching to preview, the editor is replaced by a read-only renderer that uses the same HTML content and image normalization.
